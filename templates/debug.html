<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Debug</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        .status {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .connected { color: green; }
        .disconnected { color: red; }
        .message { 
            margin-bottom: 8px;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .message-self {
            background-color: #e6f7ff;
        }
        .message-other {
            background-color: #f9f9f9;
        }
        .controls {
            margin-top: 20px;
        }
        button {
            padding: 8px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0069d9;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>NWNX-EE WebSocket Debug</h1>
        
        <div class="debug-panel">
            <div class="status">Status: <span id="connection-status" class="disconnected">Disconnected</span></div>
            <div>Socket ID: <span id="socket-id">None</span></div>
        </div>
        
        <h2>Messages</h2>
        <div class="messages" id="message-log"></div>
        
        <div class="controls">
            <button id="test-message">Send Test Message</button>
            <button id="simple-test">Simple Test</button>
            <button id="check-connection">Check Connection</button>
            <button id="reconnect">Reconnect</button>
            <button id="clear-log">Clear Log</button>
        </div>
        
        <div class="controls mt-3">
            <button id="check-dom">Check Main UI</button>
            <button id="force-msg">Force Add Message to UI</button>
            <button id="test-player-message">Test Player Message</button>
            <button id="test-player-endpoint">Test Endpoint</button>
        </div>
        
        <h2>Connection Information</h2>
        <div class="debug-panel">
            <pre id="connection-info">Waiting for connection...</pre>
        </div>
    </div>
    
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <script>
        // DOM elements
        const statusEl = document.getElementById('connection-status');
        const socketIdEl = document.getElementById('socket-id');
        const messageLogEl = document.getElementById('message-log');
        const connInfoEl = document.getElementById('connection-info');
        const testBtn = document.getElementById('test-message');
        const checkBtn = document.getElementById('check-connection');
        const reconnectBtn = document.getElementById('reconnect');
        const clearBtn = document.getElementById('clear-log');
        
        // Helper functions
        function logMessage(msg, data = null) {
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            
            const timestamp = new Date().toLocaleTimeString();
            const content = data ? `${msg}: ${JSON.stringify(data, null, 2)}` : msg;
            
            msgEl.innerHTML = `<strong>[${timestamp}]</strong> ${content}`;
            messageLogEl.appendChild(msgEl);
            messageLogEl.scrollTop = messageLogEl.scrollHeight;
            
            console.log(`[${timestamp}] ${msg}`, data);
        }
        
        function updateConnectionStatus(connected) {
            statusEl.className = connected ? 'connected' : 'disconnected';
            statusEl.textContent = connected ? 'Connected' : 'Disconnected';
        }
        
        function updateConnectionInfo(socket) {
            const info = {
                id: socket.id,
                connected: socket.connected,
                disconnected: socket.disconnected,
                transport: socket.io?.engine?.transport?.name || 'unknown'
            };
            
            socketIdEl.textContent = socket.id || 'None';
            connInfoEl.textContent = JSON.stringify(info, null, 2);
        }
        
        // Initialize Socket.IO
        const socket = io({
            reconnectionDelayMax: 5000,
            reconnectionDelay: 1000
        });
        
        // Socket.IO event listeners
        socket.on('connect', () => {
            logMessage('Connected to server');
            updateConnectionStatus(true);
            updateConnectionInfo(socket);
        });
        
        socket.on('disconnect', (reason) => {
            logMessage(`Disconnected: ${reason}`);
            updateConnectionStatus(false);
        });
        
        socket.on('connect_error', (error) => {
            logMessage(`Connection error: ${error.message}`);
            updateConnectionStatus(false);
        });
        
        // Handle messages
        socket.on('new_message', (data) => {
            logMessage('Received new_message event', data);
            
            const msgEl = document.createElement('div');
            msgEl.className = `message ${data.is_own ? 'message-self' : 'message-other'}`;
            msgEl.innerHTML = data.message;
            
            messageLogEl.appendChild(msgEl);
            messageLogEl.scrollTop = messageLogEl.scrollHeight;
        });
        
        socket.on('system_message', (data) => {
            logMessage('Received system_message event', data);
            
            const msgEl = document.createElement('div');
            msgEl.className = 'message';
            msgEl.style.backgroundColor = '#fff3cd';
            msgEl.innerHTML = `<strong>System:</strong> ${data.message}`;
            
            messageLogEl.appendChild(msgEl);
            messageLogEl.scrollTop = messageLogEl.scrollHeight;
        });
        
        // Button event listeners
        testBtn.addEventListener('click', () => {
            logMessage('Requesting test message from server');
            fetch('/api/debug/send_test_message')
                .then(response => response.json())
                .then(data => {
                    logMessage('Server response', data);
                })
                .catch(error => {
                    logMessage(`Error sending test message: ${error.message}`);
                });
        });
        
        document.getElementById('simple-test').addEventListener('click', () => {
            logMessage('Requesting simple test message');
            fetch('/api/debug/simple_test')
                .then(response => response.json())
                .then(data => {
                    logMessage('Simple test response', data);
                })
                .catch(error => {
                    logMessage(`Error sending simple test: ${error.message}`);
                });
        });
        
        checkBtn.addEventListener('click', () => {
            logMessage('Checking connection status');
            updateConnectionInfo(socket);
            logMessage(`Socket connected: ${socket.connected}`);
        });
        
        reconnectBtn.addEventListener('click', () => {
            logMessage('Manually reconnecting...');
            socket.disconnect();
            setTimeout(() => {
                socket.connect();
            }, 1000);
        });
        
        clearBtn.addEventListener('click', () => {
            messageLogEl.innerHTML = '';
            logMessage('Log cleared');
        });
        
        // DOM inspection and manipulation
        document.getElementById('check-dom').addEventListener('click', () => {
            // Check the main UI's chat messages container
            try {
                const mainChatEl = parent.document.getElementById('chat-messages');
                if (mainChatEl) {
                    logMessage('Main chat container found');
                    const messageCount = mainChatEl.children.length;
                    logMessage(`Current message count: ${messageCount}`);
                    
                    const html = mainChatEl.innerHTML;
                    logMessage(`Current content: ${html.substring(0, 150)}${html.length > 150 ? '...' : ''}`);
                } else {
                    logMessage('ERROR: Main chat container not found');
                }
            } catch (error) {
                logMessage(`Error checking main UI: ${error.message}`);
            }
        });
        
        document.getElementById('force-msg').addEventListener('click', () => {
            try {
                const mainChatEl = parent.document.getElementById('chat-messages');
                if (mainChatEl) {
                    logMessage('Adding message directly to main UI');
                    
                    // Create a message element
                    const msgEl = document.createElement('div');
                    msgEl.className = 'message message-other';
                    msgEl.innerHTML = '<strong>FORCED:</strong> This message was added directly to the DOM';
                    
                    // Add timestamp
                    const timeEl = document.createElement('div');
                    timeEl.className = 'message-time';
                    timeEl.textContent = new Date().toLocaleTimeString();
                    msgEl.appendChild(timeEl);
                    
                    // Add to the container
                    mainChatEl.appendChild(msgEl);
                    
                    // Scroll to bottom
                    mainChatEl.scrollTop = mainChatEl.scrollHeight;
                    
                    logMessage('Message added successfully');
                } else {
                    logMessage('ERROR: Could not find main chat container');
                }
            } catch (error) {
                logMessage(`Error forcing message: ${error.message}`);
            }
        });
        
        // Add test player message button handler
        document.getElementById('test-player-message').addEventListener('click', () => {
            try {
                // Send a player_message event
                logMessage('Sending test player_message event');
                
                const playerName = "Test Player";
                const playerMessage = "This is a test message that should be selectable for AI response";
                
                // First send a properly formatted message that will appear in the chat
                socket.emit('new_message', {
                    character: 'Debug',
                    message: `<strong>${playerName}:</strong> ${playerMessage}`,
                    raw_message: `[TestAccount] ${playerName}: [Talk] ${playerMessage}`,
                    is_own: false,
                    original_message: playerMessage
                });
                
                // Then send a player_message event that will trigger the "message needs response" logic
                socket.emit('player_message', {
                    character: 'Active Character',
                    player_name: playerName,
                    message: playerMessage
                });
                
                logMessage('Test player message sent successfully');
            } catch (error) {
                logMessage(`Error sending test player message: ${error.message}`);
            }
        });
        
        // Add test player endpoint button handler
        document.getElementById('test-player-endpoint').addEventListener('click', () => {
            logMessage('Calling test_player_message endpoint');
            fetch('/api/debug/test_player_message')
                .then(response => response.json())
                .then(data => {
                    logMessage('Endpoint response', data);
                })
                .catch(error => {
                    logMessage(`Error calling endpoint: ${error.message}`);
                });
        });
    </script>
</body>
</html> 